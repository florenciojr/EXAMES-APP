const express = require('express');
const cors = require('cors');
require('dotenv').config();
const path = require('path');
const fs = require('fs');

const app = express();

// ... c√≥digo anterior ...

// ‚úÖ ROTAS DE TESTE R√ÅPIDO PARA BD
app.get('/api/test/db', async (req, res) => {
  try {
    console.log('üß™ Testando conex√£o com BD...');
    const { query } = require('./config/database');
    
    // Teste simples
    const result = await query('SELECT 1 + 1 as result');
    console.log('‚úÖ Resultado do teste BD:', result[0].result);
    
    res.json({
      success: true,
      message: 'Conex√£o com BD funcionando!',
      testResult: result[0].result,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    console.error('‚ùå Erro na conex√£o com BD:', error);
    res.status(500).json({
      success: false,
      message: 'Erro na conex√£o com BD',
      error: error.message
    });
  }
});

app.get('/api/test/exams', async (req, res) => {
  try {
    console.log('üß™ Testando busca de exames na BD...');
    const Exam = require('./models/Exam');
    
    const exams = await Exam.findAll();
    console.log(`‚úÖ Encontrados ${exams.length} exames na BD`);
    
    res.json({
      success: true,
      message: `Encontrados ${exams.length} exames`,
      exams: exams,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    console.error('‚ùå Erro ao buscar exames:', error);
    res.status(500).json({
      success: false,
      message: 'Erro ao buscar exames',
      error: error.message
    });
  }
});

app.get('/api/test/exam/:id', async (req, res) => {
  try {
    const { id } = req.params;
    console.log(`üß™ Testando busca do exame ${id} na BD...`);
    const Exam = require('./models/Exam');
    
    const exam = await Exam.findById(id);
    
    if (!exam) {
      return res.status(404).json({
        success: false,
        message: `Exame ${id} n√£o encontrado`
      });
    }
    
    console.log(`‚úÖ Exame encontrado: ${exam.title}`);
    
    res.json({
      success: true,
      message: 'Exame encontrado',
      exam: exam,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    console.error('‚ùå Erro ao buscar exame:', error);
    res.status(500).json({
      success: false,
      message: 'Erro ao buscar exame',
      error: error.message
    });
  }
});

app.get('/api/test/exam/:id/questions', async (req, res) => {
  try {
    const { id } = req.params;
    console.log(`üß™ Testando busca de quest√µes do exame ${id}...`);
    const Exam = require('./models/Exam');
    
    const questions = await Exam.getQuestions(id);
    console.log(`‚úÖ Encontradas ${questions.length} quest√µes`);
    
    res.json({
      success: true,
      message: `Encontradas ${questions.length} quest√µes`,
      questions: questions,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    console.error('‚ùå Erro ao buscar quest√µes:', error);
    res.status(500).json({
      success: false,
      message: 'Erro ao buscar quest√µes',
      error: error.message
    });
  }
});

// ‚úÖ ROTAS DE FALLBACK PARA COMPATIBILIDADE
app.get('/exams', (req, res) => {
  console.log('‚ö†Ô∏è  Redirecionando /exams para /api/exams');
  req.originalUrl = '/api/exams';
  req.url = '/api/exams';
  app.handle(req, res);
});

app.get('/exams/:id', (req, res) => {
  console.log(`‚ö†Ô∏è  Redirecionando /exams/${req.params.id} para /api/exams/${req.params.id}`);
  req.originalUrl = `/api/exams/${req.params.id}`;
  req.url = `/api/exams/${req.params.id}`;
  app.handle(req, res);
});

// ... resto do c√≥digo ...

// Middleware b√°sico
app.use(cors());
app.use(express.json({ limit: '10mb' }));

// Middleware de logging para debug
app.use((req, res, next) => {
  console.log(`${new Date().toISOString()} - ${req.method} ${req.originalUrl}`);
  if (req.method === 'POST' && (req.originalUrl.includes('login') || req.originalUrl.includes('save-history'))) {
    console.log('Body received:', JSON.stringify(req.body, null, 2));
  }
  next();
});

// ‚úÖ FUN√á√ÉO MELHORADA PARA CARREGAR ROTAS
const loadRoutes = (routePath, routeName) => {
  try {
    const fullPath = path.join(__dirname, routePath);
    
    console.log(`üîç Tentando carregar: ${fullPath}.js`);
    
    // Verificar se o arquivo existe
    if (!fs.existsSync(fullPath + '.js')) {
      console.error(`‚ùå Arquivo de rotas n√£o encontrado: ${fullPath}.js`);
      
      // Tentar encontrar o arquivo em localiza√ß√µes alternativas
      const alternativePaths = [
        path.join(__dirname, '..', 'routes', routeName),
        path.join(__dirname, 'routes', routeName),
        path.join(__dirname, 'src', 'routes', routeName),
        path.join(__dirname, routeName) // Tentar caminho direto
      ];
      
      for (const altPath of alternativePaths) {
        if (fs.existsSync(altPath + '.js')) {
          console.log(`‚úÖ Encontrado em localiza√ß√£o alternativa: ${altPath}.js`);
          const routes = require(altPath);
          app.use(`/api/${routeName}`, routes);
          console.log(`‚úÖ Rotas de ${routeName} carregadas de ${altPath}.js`);
          return true;
        }
      }
      
      return false;
    }
    
    const routes = require(fullPath);
    app.use(`/api/${routeName}`, routes);
    console.log(`‚úÖ Rotas de ${routeName} carregadas de ${fullPath}.js`);
    return true;
  } catch (error) {
    console.error(`‚ùå Erro ao carregar rotas de ${routeName}:`, error.message);
    return false;
  }
};

// ‚úÖ VERIFICAR E CRIAR ROTAS DE AUTENTICA√á√ÉO SE NECESS√ÅRIO
const ensureAuthRoutes = () => {
  console.log('‚ö†Ô∏è  Arquivo auth.js n√£o encontrado, criando rotas b√°sicas...');
  
  // Rota de login b√°sica
  app.post('/api/auth/login', (req, res) => {
    console.log('üìß Login simulado (modo desenvolvimento)');
    
    const jwt = require('jsonwebtoken');
    const token = jwt.sign(
      { 
        id: 1, 
        email: req.body.email 
      },
      process.env.JWT_SECRET || 'secret_key_123',
      { expiresIn: '24h' }
    );
    
    res.json({
      success: true,
      message: 'Login realizado com sucesso',
      token,
      user: {
        id: 1,
        name: 'Usu√°rio de Teste',
        email: req.body.email
      }
    });
  });
  
  // Rota de health check para auth
  app.get('/api/auth/health', (req, res) => {
    res.json({
      success: true,
      message: 'Rota de autentica√ß√£o funcionando (modo desenvolvimento)',
      timestamp: new Date().toISOString()
    });
  });
  
  console.log('‚úÖ Rotas b√°sicas de auth criadas');
  return true;
};

// ‚úÖ VERIFICAR E CRIAR ROTAS DE EXAMES SE NECESS√ÅRIO
const ensureExamRoutes = () => {
  console.log('‚ö†Ô∏è  Arquivo exams.js n√£o encontrado, criando rotas b√°sicas...');
  
  // Rota b√°sica para listar exames
  app.get('/api/exams', (req, res) => {
    console.log('üìù Listando exames (modo desenvolvimento)');
    
    // Dados de exemplo para desenvolvimento
    const examesExemplo = [
      {
        id: 1,
        title: "Exemplo de Exame de Matem√°tica",
        description: "Exame de matem√°tica b√°sica",
        subject: "Matem√°tica",
        difficulty: "m√©dio",
        total_questions: 10,
        duration_minutes: 60,
        is_active: true
      },
      {
        id: 2,
        title: "Exemplo de Exame de Portugu√™s",
        description: "Exame de gram√°tica e interpreta√ß√£o de texto",
        subject: "Portugu√™s",
        difficulty: "f√°cil",
        total_questions: 8,
        duration_minutes: 45,
        is_active: true
      }
    ];
    
    res.json(examesExemplo);
  });
  
  // Rota b√°sica para buscar exame espec√≠fico
  app.get('/api/exams/:id', (req, res) => {
    const { id } = req.params;
    console.log(`üìù Buscando exame ID: ${id} (modo desenvolvimento)`);
    
    // Quest√µes de exemplo
    const questionsExemplo = [
      {
        id: 1,
        text: "Qual √© a f√≥rmula da √°rea do c√≠rculo?",
        options: ["œÄr¬≤", "2œÄr", "œÄd", "r¬≤"],
        answer: 0,
        explanation: "A √°rea do c√≠rculo √© calculada por œÄ multiplicado pelo raio ao quadrado.",
        topic: "Geometria",
        difficulty: "f√°cil"
      },
      {
        id: 2,
        text: "Quanto √© 2 + 2 √ó 2?",
        options: ["6", "8", "4", "10"],
        answer: 0,
        explanation: "Primeiro multiplicamos 2 √ó 2 = 4, depois somamos 2 + 4 = 6.",
        topic: "Aritm√©tica",
        difficulty: "f√°cil"
      }
    ];
    
    const examExemplo = {
      id: parseInt(id),
      title: "Exemplo de Exame",
      description: "Este √© um exame de exemplo para desenvolvimento",
      subject: "Matem√°tica",
      difficulty: "m√©dio",
      total_questions: 2,
      duration_minutes: 30,
      questions: questionsExemplo
    };
    
    res.json(examExemplo);
  });
  
  // Health check para exames
  app.get('/api/exams/health', (req, res) => {
    res.json({
      success: true,
      message: 'Rota de exames funcionando (modo desenvolvimento)',
      timestamp: new Date().toISOString()
    });
  });
  
  console.log('‚úÖ Rotas b√°sicas de exams criadas');
  return true;
};

// ‚úÖ CARREGAR TODAS AS ROTAS
console.log('üîÑ Carregando rotas...');

// 1. Primeiro tentar carregar auth normalmente
const authLoaded = loadRoutes('./routes/auth', 'auth');

// 2. Se auth n√£o carregar, criar rotas b√°sicas
if (!authLoaded) {
  ensureAuthRoutes();
}

// 3. Carregar outras rotas - com fallback
const examsLoaded = loadRoutes('./routes/exams', 'exams');
if (!examsLoaded) {
  ensureExamRoutes();
}

// 4. Carregar outras rotas com fallback b√°sico
loadRoutes('./routes/questions', 'questions') || console.log('‚ö†Ô∏è  Rotas de questions n√£o carregadas');
loadRoutes('./routes/history', 'history') || console.log('‚ö†Ô∏è  Rotas de history n√£o carregadas');
loadRoutes('./routes/aiRoutes', 'ai') || console.log('‚ö†Ô∏è  Rotas de AI n√£o carregadas');

// ‚úÖ ROTA DE FALLBACK PARA /auth/login (COMPATIBILIDADE)
app.post('/auth/login', (req, res) => {
  console.log('‚ö†Ô∏è  Usando rota de fallback /auth/login');
  
  // Simplesmente redireciona para a rota correta
  req.originalUrl = '/api/auth/login';
  req.url = '/api/auth/login';
  app.handle(req, res);
});

// ‚úÖ ROTA DE HEALTH CHECK MELHORADA
app.get('/api/health', (req, res) => {
  const routes = [];
  
  // Verificar todas as rotas carregadas
  app._router.stack.forEach(layer => {
    if (layer.name === 'router') {
      const routePath = layer.regexp.toString()
        .replace(/^\/\^\\\/api\\\/([^\\]+).*$/, '/api/$1')
        .replace(/\\/g, '');
      routes.push(routePath);
    }
  });
  
  res.json({ 
    success: true,
    message: '‚úÖ API funcionando!',
    timestamp: new Date().toISOString(),
    routes: routes.filter(route => route !== '/api/$1')
  });
});

// ‚úÖ ROTA DE DEBUG PARA LISTAR TODAS AS ROTAS
app.get('/api/debug/routes', (req, res) => {
  const allRoutes = [];
  
  app._router.stack.forEach(layer => {
    if (layer.route) {
      // Rota direta
      allRoutes.push({
        path: layer.route.path,
        methods: Object.keys(layer.route.methods),
        type: 'direct'
      });
    } else if (layer.name === 'router') {
      // Rota com router
      const basePath = layer.regexp.toString()
        .replace(/^\/\^\\\/api\\\/([^\\]+).*$/, '/api/$1')
        .replace(/\\/g, '');
      
      layer.handle.stack.forEach(handler => {
        if (handler.route) {
          allRoutes.push({
            path: basePath + handler.route.path,
            methods: Object.keys(handler.route.methods),
            type: 'router'
          });
        }
      });
    }
  });
  
  res.json({
    success: true,
    count: allRoutes.length,
    routes: allRoutes
  });
});

// ‚úÖ ROTA RAIZ MELHORADA
app.get('/', (req, res) => {
  res.json({ 
    success: true,
    message: 'Bem-vindo √† API EXAMES-APP',
    version: '1.0.0',
    status: 'online',
    timestamp: new Date().toISOString(),
    endpoints: {
      health: '/api/health',
      debug: '/api/debug/routes',
      auth: {
        login: '/api/auth/login',
        fallback: '/auth/login',
        health: '/api/auth/health'
      },
      exams: '/api/exams',
      examsHealth: '/api/exams/health'
    }
  });
});

// ‚úÖ MIDDLEWARE DE ERRO MELHORADO
app.use((error, req, res, next) => {
  console.error('‚ùå Erro n√£o tratado:', error);
  res.status(500).json({ 
    success: false,
    message: 'Erro interno do servidor',
    error: process.env.NODE_ENV === 'development' ? error.message : 'Ocorreu um erro',
    timestamp: new Date().toISOString()
  });
});

// ‚úÖ ROTA N√ÉO ENCONTRADA MELHORADA
app.use('*', (req, res) => {
  console.log('‚ùå Rota n√£o encontrada:', req.originalUrl);
  
  // Coletar todas as rotas dispon√≠veis
  const availableRoutes = [];
  app._router.stack.forEach(layer => {
    if (layer.route) {
      availableRoutes.push({
        path: layer.route.path,
        methods: Object.keys(layer.route.methods)
      });
    } else if (layer.name === 'router') {
      const basePath = layer.regexp.toString()
        .replace(/^\/\^\\\/api\\\/([^\\]+).*$/, '/api/$1')
        .replace(/\\/g, '');
      
      layer.handle.stack.forEach(handler => {
        if (handler.route) {
          availableRoutes.push({
            path: basePath + handler.route.path,
            methods: Object.keys(handler.route.methods)
          });
        }
      });
    }
  });
  
  res.status(404).json({ 
    success: false,
    message: 'Rota n√£o encontrada',
    path: req.originalUrl,
    timestamp: new Date().toISOString(),
    availableRoutes: availableRoutes.slice(0, 10) // Mostrar apenas as primeiras 10
  });
});

const PORT = process.env.PORT || 5000;

app.listen(PORT, '0.0.0.0', () => {
  console.log(`üöÄ Servidor rodando na porta ${PORT}`);
  console.log(`üìç Local: http://localhost:${PORT}`);
  console.log(`üåê Rede: http://192.168.1.2:${PORT}`);
  console.log(`üìä Health Check: http://localhost:${PORT}/api/health`);
  console.log(`üîç Debug Routes: http://localhost:${PORT}/api/debug/routes`);
  console.log(`üìù Exams: http://localhost:${PORT}/api/exams`);
  console.log(`üìù Exam Example: http://localhost:${PORT}/api/exams/1`);
  console.log(`üîê Login: http://localhost:${PORT}/api/auth/login`);
  console.log(`üîê Login (fallback): http://localhost:${PORT}/auth/login`);
  console.log('');
  console.log('‚úÖ Servidor configurado com:');
  console.log('   - Rotas de autentica√ß√£o (/api/auth/login)');
  console.log('   - Rotas de exames (/api/exams)');
  console.log('   - Fallback para compatibilidade (/auth/login)');
  console.log('   - Sistema de rotas resiliente');
  console.log(`üåê Rede: http://192.168.1.2:${PORT}`);
  console.log('');
  console.log('üìä TESTES R√ÅPIDOS:');
  console.log(`   - Health Check: http://localhost:${PORT}/api/health`);
  console.log(`   - Teste BD: http://localhost:${PORT}/api/test/db`);
  console.log(`   - Teste Exames: http://localhost:${PORT}/api/test/exams`);
  console.log(`   - Teste Exame 1: http://localhost:${PORT}/api/test/exam/1`);
  console.log(`   - Teste Quest√µes: http://localhost:${PORT}/api/test/exam/1/questions`);
  console.log('');
  console.log('üîç DEBUG:');
  console.log(`   - Debug Routes: http://localhost:${PORT}/api/debug/routes`);
  console.log('');
  console.log('üéØ ROTAS PRINCIPAIS:');
  console.log(`   - Exams: http://localhost:${PORT}/api/exams`);
  console.log(`   - Exam Example: http://localhost:${PORT}/api/exams/1`);
  console.log(`   - Login: http://localhost:${PORT}/api/auth/login`);
  console.log(`   - Login Fallback: http://localhost:${PORT}/auth/login`);

  
  // Debug das rotas ap√≥s inicializa√ß√£o
  setTimeout(() => {
    console.log('\nüîç ROTAS DISPON√çVEIS:');
    app._router.stack.forEach(layer => {
      if (layer.route) {
        console.log(`   ${Object.keys(layer.route.methods).join(', ').toUpperCase()} ${layer.route.path}`);
      } else if (layer.name === 'router') {
        const basePath = layer.regexp.toString()
          .replace(/^\/\^\\\/api\\\/([^\\]+).*$/, '/api/$1')
          .replace(/\\/g, '');
        
        layer.handle.stack.forEach(handler => {
          if (handler.route) {
            console.log(`   ${Object.keys(handler.route.methods).join(', ').toUpperCase()} ${basePath}${handler.route.path}`);
          }
        });
      }
    });
  }, 100);
});